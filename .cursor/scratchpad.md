## Background and Motivation

Stile della sidebar: il colore del nome (email) dell'utente loggato nella `Sidebar` non è soddisfacente e va allineato al sistema di token `sidebar-*` per leggibilità e coerenza visiva.

Dashboard: è stato richiesto un grafico SPANCO circolare (donut chart) che mostri quante trattative attive si trovano in ciascuno stato SPANCO, usando l'endpoint `/api/statistics/negotiations/spanco` e Recharts. Il grafico deve essere grande, senza card/container evidente, con il totale delle trattative al centro.

Deploy: la build su Vercel per il monorepo (Bun + Turborepo + Next.js) rimane bloccata nella fase di `bun install`, fermandosi al log `Resolved, downloaded and extracted [62]` senza procedere alla fase di build dell'app.

## Key Challenges and Analysis

- Evitare di usare `primary-foreground` in un contesto non primario, così da non perdere contrasto con lo sfondo della sidebar.
- Mantenere la coerenza con i token già definiti in `globals.css` (`--color-sidebar-*`) e con il comportamento tra layout verticale e orizzontale della `Sidebar`.
- Capire se il blocco di `bun install` su Vercel è dovuto a una dipendenza locale (`motion-plus` via `.tgz`), a una configurazione errata del package manager o a uno script che si comporta diversamente in ambiente CI.
- Verificare che la struttura del monorepo (workspaces `apps/*` e `packages/*`, `bun.lock`, `packageManager` Bun) sia compatibile con la configurazione corrente del progetto Vercel (Install/Build command, directory di output).

## High-level Task Breakdown

1. Identificare il punto in cui viene renderizzato il nome/email dell'utente loggato in `Sidebar`.
2. Aggiornare le classi Tailwind in modo che il testo usi un colore `sidebar-*` appropriato (es. `text-sidebar-primary`) mantenendo la struttura esistente.
3. Verificare che non ci siano errori di compilazione/lint e che il rendering sia corretto sia in tema chiaro che scuro.
4. Riprodurre localmente il problema di deploy eseguendo `bun install` dalla root del monorepo e osservare se si blocca o genera errori, annotando l'output completo (successo: `bun install` termina correttamente in locale).
5. Analizzare e, se necessario, correggere la dipendenza locale `motion-plus` in `package.json` (percorso `.tgz` e inclusione nel repo) affinché Bun riesca a risolverla e installarla sia in locale sia su Vercel (successo: `bun install` completa anche in CI senza blocchi nella fase di linking).
6. Verificare e allineare la configurazione del progetto Vercel allo stack Bun + Turborepo + Next.js (Install command `bun install`, Build command `turbo build` o `bun run build`, directory di output `apps/web/.next`) e aggiornare la documentazione interna se necessario (successo: configurazione consistente tra locale e CI).
7. Rieseguire una build su Vercel, controllare i log fino al termine e confermare che la fase di installazione superi il punto "Resolved, downloaded and extracted [...]" e che la build Next.js arrivi al termine senza errori (successo: deploy completo e preview/production raggiungibile).

## Project Status Board

- [ ] Aggiornare il colore del nome/email dell'utente loggato nella `Sidebar` usando i token `sidebar-*`.
- [ ] Aggiornare la palette dark per lo schema colore `"rich"` (tema **Dataweb**) definendo nuovi valori oklch in `globals.css` per migliorare contrasto e leggibilità.
- [ ] Aggiungere pagina e voce di navigazione per le **trattative aperte** (`/trattative/aperte`) utilizzando `TrattativeTable` con filtro corretto.
- [ ] Rifinire lo stile del dialog "Nuova trattativa" (pagina `/trattative/aperte` e affini) rendendo il contenuto più arrotondato e allineato ai pattern di design esistenti (label+input/ select con pill arrotondate).
- [ ] Aggiungere in dashboard il grafico SPANCO ad anello (Recharts) alimentato da `/statistics/negotiations/spanco` per mostrare le trattative attive per stato.
- [ ] Implementare il flusso di **Password dimenticata** e **Reset password** (dialog nella pagina di login + pagina `/reset-password`), usando gli endpoint `/api/forgot-password` e `/api/reset-password` come da specifica.
- [ ] Risolvere il blocco di deploy su Vercel (`bun install` che si ferma a "Resolved, downloaded and extracted [...]") assicurando che la build completi e che l'app web sia correttamente deployata.
 - [ ] Rifinire la larghezza delle colonne della tabella trattative (`/trattative/tutte`), riducendo leggermente la colonna Importo e dando più spazio a Note e Percentuale per evitare ampi vuoti visivi.
- [ ] Aggiornare le pill di stato delle trattative con i nuovi colori: azzurro per aperte, verde per concluse, rosso invariato per abbandonate.
- [ ] Abilitare l'ordinamento per colonna Importo nella tabella delle trattative.
- [ ] Abilitare l'ordinamento per colonna Percentuale nella tabella delle trattative.
- [ ] Abilitare l'ordinamento della colonna Spanco rispettando l'ordine S → P → A → N → C → O.
- [ ] Rendere la colonna SPANCO nella tabella delle trattative una pill di stato compatta per migliorare la leggibilità visiva.
- [ ] Rendere la colonna Percentuale nella tabella delle trattative una barra di avanzamento con aspetto "slider" e valore percentuale visibile all'interno.
- [ ] Spostare l'input di ricerca delle trattative su una nuova riga dell'header e aggiungere un filtro per le fasi SPANCO nello stile dei filtri header.
- [ ] Allineare l'input di ricerca e il bottone "Aggiungi" sulla stessa riga nella pagina `/trattative/concluse` quando non sono presenti filtri header.
 - [ ] Allineare la barra di ricerca dei clienti sulla stessa riga del titolo nella pagina `/clienti`.
- [ ] Rendere pienamente funzionante la ricerca nella tabella clienti (`/clienti`) e avvolgere il totale clienti in `AnimateNumber` per un contatore animato.
 - [ ] Allineare l'icona del titolo "Clienti" nella pagina `/clienti` con quella usata per la voce "Clienti" nella `Sidebar`.

## Executor's Feedback or Assistance Requests

- **Vercel build + motion-plus:** Per sbloccare la build senza rimuovere motion-plus: (1) Aggiunto `scripts/vercel-install.sh` che, se `MOTION_TOKEN` è impostato, scarica `motion-plus.tgz` in `scripts/` e poi esegue `bun install`. (2) Aggiunto `vercel.json` con `installCommand: "bash scripts/vercel-install.sh"`. (3) Documentato in README: in Vercel va impostata la variabile d'ambiente `MOTION_TOKEN`. L'utente deve aggiungere `MOTION_TOKEN` nelle Environment Variables del progetto Vercel e rieseguire il deploy.
- **GlobalSearchCommand (⌘K) su /clienti:** Ho applicato il feedback di pagina: (1) dialog centrato nella viewport: il contenitore è passato da `items-start justify-center pt-[15vh]` a `items-center justify-center p-4`; (2) input “floating”: rimosso il border-bottom, aggiunto wrapper `.global-search-input-wrap` con padding (top e lati) e input con `background: var(--muted)`, `border-radius: var(--radius-md)` e padding interno, senza bordo. Corretto anche l’ordine dei selettori in `cmdk.css` per il lint (specificity). Chiedo una verifica visiva su /clienti (aprire la command palette con ⌘K/Ctrl+K) prima di considerare il task chiuso.
- Implementazione in corso per il colore del nome dell'utente loggato nella `Sidebar`. Dopo la modifica chiederò conferma all'utente per validare il risultato visivo prima di segnare il task come completato nella board.
- Sto lavorando ora in priorità sulla palette dark del tema **Dataweb** (`data-color-scheme="rich"`), aggiornando i token nella sezione `.dark[data-color-scheme="rich"]` di `globals.css`. Dopo le modifiche suggerirò un check visivo all'utente prima che il Planner dichiari il task completato.
- Ho iniziato a lavorare sulla pagina per le **trattative aperte**, aggiungendo la voce dedicata in `Sidebar` e collegandola alla route `/trattative/aperte` con un filtro che mostri solo le trattative effettivamente aperte (non abbandonate e non concluse).
- Ho aggiunto il token `--table-hover` per i temi predefiniti light e dark in `globals.css` così che l'hover `bg-table-hover` sulle righe della tabella sia visibile e coerente anche fuori dallo schema colore `rich`. Da validare visivamente in entrambi i temi.
 - Ho implementato un nuovo client API per `/api/statistics/negotiations/spanco` (`getNegotiationsSpancoStatistics`) e un componente `SpancoDonutChart` basato su Recharts, integrato nella pagina `DashboardPage`. Il grafico è grande, centrato, senza card dedicata, e mostra il totale delle trattative attive al centro con una legenda compatta sotto.
- Ho implementato il grafico SPANCO ad anello in dashboard usando Recharts (`SpancoDonutChart`) e l'endpoint `/statistics/negotiations/spanco`, con gestione chiara di loading/errore e legenda compatta; attendo validazione visiva dal Planner/utente prima di segnare il relativo task come completato.
- Ho iniziato a lavorare sul flusso di reset password: aggiungerò un dialog "Password dimenticata?" nella pagina di login e una pagina `/reset-password` che legge `token` ed `email` dalla query string, gestendo gli errori 429 (rate limit), 400 (token non valido) e 422 (validazione password) come da documento di specifica; chiederò all'utente di verificare manualmente l'invio mail e il redirect al login prima di segnare il task come completato.
 - Ho aggiornato la dipendenza `motion-plus` nella root `package.json` da pacchetto locale (`"./motion-plus.tgz"`, che non era versionato su Git/Vercel) alla versione pubblicata su npm (`"^1.5.1"`), eseguito `bun install` dalla root e verificato che `bun run build` (che lancia `turbo build` e `next build` per `web`) completi con successo in locale. Questo dovrebbe evitare blocchi legati alla risoluzione del pacchetto su Vercel.
 - Ho regolato il template di griglia delle colonne in `TrattativeTable` (header e righe) per la pagina `/trattative/tutte`, riducendo leggermente la larghezza massima della colonna "Importo" e aumentando quella della percentuale e delle note, così da eliminare l'eccesso di spazio vuoto sull'importo e dare più aria al contenuto testuale e alla pill di avanzamento.
 - Ho ulteriormente ampliato la colonna "Cliente" nella `TrattativeTable` rimuovendo l'avatar per lasciare più spazio al nome (specialmente per ragioni sociali lunghe) e ho aumentato il contrasto del testo all'interno della pill di avanzamento percentuale usando `text-foreground`, così che il valore (es. "30%") risulti più leggibile sopra il track e la barra verde.
- Ho aggiornato le pill di stato in `TrattativeTable` applicando il nuovo schema cromatico richiesto (azzurro per aperte, verde per concluse, rosso invariato per abbandonate) e chiedo un controllo visivo per confermare che i colori siano corretti.
- Ho implementato l'ordinamento per "Importo" in `TrattativeTable` con un controllo nel header che cicla tra nessun ordinamento, decrescente e crescente; invito l'utente a verificare che il comportamento sia corretto prima di chiudere il task.
- Sto estendendo lo stesso comportamento di ordinamento alle colonne "Spanco" (ordine S → P → A → N → C → O) e "Percentuale", assicurandomi che sia attivo un solo ordinamento alla volta; aggiornerò qui quando pronto per la validazione.
 - Ho aggiornato l'allineamento del bottone di ordinamento "Importo" nell'header di `TrattativeTable` su `/trattative/tutte`, passando da `justify-end` a `justify-start` per rispettare il feedback visivo sulla disposizione del testo e dell'icona.
- Ho trasformato il valore SPANCO nella `TrattativeTable` in una pill di stato compatta (chip arrotondato con background `bg-table-header` e testo tabulare), in modo da renderlo visivamente coerente con le altre pill di stato pur mantenendo una gerarchia visiva distinta rispetto allo stato finale della trattativa.
- Ho sostituito il semplice testo della colonna "Percentuale" in `TrattativeTable` con una barra di avanzamento orizzontale (effetto slider) che riempie in base al valore `%` e mostra il numero all'interno, migliorando la leggibilità visiva dell'avanzamento su `/trattative/tutte`; attendo conferma visiva prima di marcare il relativo task come completato.
- Ho aggiornato l'header di `TrattativeTable` spostando la barra di ricerca su una seconda riga dedicata e aggiungendo un filtro locale per le fasi SPANCO (basato su Radix `Select`), così da poter limitare rapidamente la vista a una singola fase; chiedo una verifica visiva e funzionale sulla pagina `/trattative/tutte` prima di segnare il relativo task nella board come completato.
- Ho allineato il colore di background dei filtri SPANCO/Stato alla stessa variabile usata per la search bar (`bg-table-buttons`), così che tutti i controlli di header abbiano lo stesso peso visivo e risultino coerenti tra loro.
- Per la search bar di `TrattativeTable` su `/trattative/tutte` ho aggiunto un'icona "delete left" dedicata che compare solo quando l'utente ha digitato del testo: cliccarla cancella il termine di ricerca e mantiene il focus nell'input, così da poter ripartire a scrivere immediatamente.
- Ho regolato il layout dell'header di `TrattativeTable` in modo che, quando non sono presenti filtri header (come su `/trattative/concluse`), il campo di ricerca venga mostrato sulla stessa riga del bottone "Aggiungi", posizionato a sinistra del bottone, mentre nelle viste con filtri mantiene la disposizione su due righe (filtri + search sotto al titolo).
 - Ho aggiunto una transizione animata tra l'icona di ricerca e l'icona "delete left" nella search bar di `TrattativeTable`, usando `AnimatePresence` di `motion/react` per far ruotare e sfumare le icone quando il campo passa da vuoto a pieno (e viceversa), mantenendo il focus nell'input quando si cancella il testo.
 - Ho aggiornato l'header di `ClientsTable` sulla pagina `/clienti` portando la barra di ricerca sulla stessa riga del titolo "Clienti", allineata a destra tramite un contenitore `flex` con `justify-between`, così da rispettare il feedback di posizionamento.
- Sto estendendo ora il comportamento di ricerca in `ClientsTable` facendo in modo che il testo digitato filtri effettivamente i risultati (lato backend e, in fallback, lato client) e aggiornando il box "Totale clienti" affinché mostri il numero di risultati correnti con un contatore animato `AnimateNumber`.
 - Ho aggiornato l'icona accanto al titolo "Clienti" nella pagina `/clienti` riutilizzando il componente `UserGroupIcon` già utilizzato nella `Sidebar`, così che la rappresentazione visiva della sezione sia coerente tra navigazione e contenuto.
- Sto lavorando sul refinement del dialog "Nuova trattativa" (`CreateNegotiationDialog`) per la pagina `/trattative/aperte` e relative viste: il contenitore interno sarà più arrotondato e ogni campo (label + input/select) verrà avvolto in una pill arrotondata condivisa, con l'input reso trasparente (senza bordo) per seguire i pattern della search bar e dei filtri header; chiederò una validazione visiva prima di marcare il task nella board come completato.
 - All'interno di `CreateNegotiationDialog` ho consolidato il campo "Percentuale avanzamento" in un unico track full-bleed: l'intera pill funge da slider (input `range` 0–100 con step 20), mentre etichetta e valore percentuale sono resi come overlay orizzontale sulla traccia; il riempimento utilizza gli stessi colori SPANCO del progress "slider" in tabella così che il dialog appaia coerente con le righe della `TrattativeTable`. Chiedo una conferma visiva, in particolare sulla pagina `/trattative/aperte`, prima che il Planner segni come completato il refinement del dialog "Nuova trattativa".
 - Ho aumentato la dimensione tipografica dell’etichetta "Percentuale avanzamento" nel dialog "Nuova trattativa" e reso il valore percentuale a destra in `font-mono` con `tabular-nums`, così che le cifre restino stabili mentre cambiano e risultino visivamente proporzionate al controllo slider, come richiesto per `/trattative/aperte`.
- Ho aggiunto un piccolo "drag handle" decorativo al track della percentuale in `CreateNegotiationDialog`: il manico è leggermente rientrato rispetto al bordo del fill e compare solo su hover/active scalando lungo l’asse X, così da suggerire interazione in modo sottile e meno aggressivo rispetto a un semplice fade-in opaco.
- Ho aggiornato la personalizzazione in `globals.css` per gli slider `create-percentuale` e `update-percentuale`: il thumb nativo ha ora dimensioni reali (18x18) ma `opacity: 0`, e il track occupa il 100% dell’altezza. In questo modo l’intero pill (inclusa l’area del nuovo handle) resta cliccabile/trascinabile, mentre a livello visivo si continua a vedere solo il track custom e il manico decorativo.
- Ho reso il "drag handle" della percentuale nel dialog `CreateNegotiationDialog` effettivamente trascinabile: ora è possibile afferrare il manico sul bordo del fill e trascinarlo orizzontalmente per aggiornare il valore della `range`, con snapping ai passi 0/20/40/60/80/100, così che il comportamento rispecchi in modo diretto l’affordance visiva.
 - Ho aumentato leggermente l’altezza del "drag handle" della percentuale nel dialog `CreateNegotiationDialog` (mantendendo larghezza e stile invariati) e l’ho spostato di pochi pixel verso l’interno del fill, così che il manico sia più visibile ma non appiccicato al bordo della barra di avanzamento nella vista `/trattative/aperte`.
 - Ho riallineato le tacche (hash marks) del track percentuale facendole estendere sull’intera larghezza utile dello slider, così che ognuna corrisponda visivamente a uno step del controllo (0, 20, 40, 60, 80, 100%) senza offset rispetto al fill.
- Ho aggiornato la pagina di dettaglio trattativa abbandonata (`/trattative/abbandonate/[id]`) facendo sì che gli stati di caricamento/auth mostrino il componente `Loader` all'interno dello stesso shell grafico (card + `table-container-bg`) usato per il contenuto e non più su sfondo nudo, così da avere un layout coerente con le altre viste di trattative.

## Lessons

- Quando si lavora con token come `primary-foreground`, usare invece i token specifici della sezione (es. `sidebar-*`) per evitare problemi di contrasto quando lo sfondo non è quello "primary".
 - Evitare dipendenze locali `.tgz` non versionate in un monorepo destinato a Vercel; preferire pacchetti pubblicati su npm (o repository privati configurati esplicitamente) così che l'install in CI non dipenda da file presenti solo in locale.

